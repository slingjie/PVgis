# 需求文档与开发计划｜太阳辐照数据查询展示（PVGIS+CAMS）与光伏发电量评估（远期）

**版本**：v1.0（汇总版）  
**日期**：2025-12-28  
**范围**：本仓库内《太阳辐照度数据获取程序（PVGIS+CAMS）开发概述》《PVGIS光伏发电量计算方案（PRD/TodoList）》汇总、去重与落地化补全

---

## 0. 一句话目标

先做一个「输入公司/地址/经纬度 → 查询并展示辐照数据」的应用（MVP），后续在同一套位置与气象数据链路上扩展「光伏发电量计算」并最终演进为小程序。

---

## 1. 背景与目标

### 1.1 背景

在光伏/新能源项目投前阶段，常需要快速获得目标地点的太阳辐照数据（GHI/DNI/DHI 等）用于可研、方案对比、报告输出；远期需要进一步完成光伏发电量估算与指标（如 PR、满发小时）计算。

### 1.2 目标（按阶段）

**一期（MVP：辐照数据查询展示）**
- 支持输入：公司名称+地理位置（作为地址字符串）、详细地址、经纬度
- 可选择数据源：PVGIS / CAMS（via SoDa/pvlib）
- 查询并展示：逐时序列 / 典型年（TMY）/ 月尺度统计（至少月均或月总）
- 支持导出：CSV（必做），报告/图片（可选）

**二期（扩展：PV 发电量评估）**
- 基于 PVGIS PV calculation 输出年/月/逐时（TMY 8760h）发电量（AC 侧）
- 计算衍生指标：PR、首年满发小时
- 支持多方案对比与报告导出（PDF）

**三期（产品形态：小程序）**
- 将一期/二期能力封装为后端服务 + 小程序前端（或 H5），支持轻量化使用与分享

---

## 2. 目标用户与核心场景

### 2.1 目标用户
- 新能源解决方案工程师/投前工程师
- 售前技术支持/项目经理
- （远期）客户/渠道在小程序中自助查询

### 2.2 核心场景
- 给出公司名称/项目地址，快速拿到辐照数据用于可研与初筛
- 对比不同地点（或不同数据源）辐照差异
- 在辐照数据基础上进行 PV 发电量测算与多方案比选（远期）

---

## 3. 范围定义（Scope）

### 3.1 一期（MVP）必须做（Must）
- 输入模式
  - 经纬度输入（lat, lon）
  - 地址输入（支持“公司名称 + 城市/区县/园区”等作为地址字符串）
- 后端地理编码：地址 → 经纬度（至少 1 个可用提供方）
- 数据源适配：PVGIS 与 CAMS（至少 PVGIS 全链路可用）
- 查询能力
  - PVGIS：逐时序列（series calc）与典型年 TMY（8760）
  - CAMS：逐时序列（1h，默认），可配置时间范围
- 结果展示
  - 表格：原始数据（可分页/虚拟滚动）
  - 图表：日内曲线/全年概览（至少 1 种）
  - 元数据：数据源、时间基准、单位、位置解析精度
- 导出：CSV（包含数据与元数据）
- 稳定性：超时、重试、限流、缓存（同参命中）

### 3.2 一期可选（Should）
- 地图选点（基于经纬度反显）
- 多地点批量查询（上传 CSV/粘贴多行）
- 结果对比（PVGIS vs CAMS，同一地点）

### 3.3 二期（PV 发电量）范围（Future）
- 系统参数录入（kWp、方位角、损耗等）并调用 PVGIS PV 计算
- 年/月/逐时（TMY）发电量展示
- PR、满发小时计算
- 多方案 A/B/C 对比与 PDF 报告导出

---

## 4. 关键口径与约定（统一口径）

### 4.1 位置口径
- 后端统一输出：`lat`、`lon`
- 保存位置解析信息：`geocode_provider`、`display_name`、`confidence/precision`

### 4.2 时间口径
- 后端统一将时间输出为 ISO8601（建议 UTC），并在 `metadata` 中给出：
  - `time_ref`（例如 `UTC`/`UT`/`local`）
  - `timezone`（如可获取）
- 对外展示时允许按用户时区渲染，但导出需保留原始 `time_ref`

### 4.3 单位口径
- 辐照度（瞬时/逐时）：W/m²（如数据源为能量则明确为 Wh/m² 或 kWh/m²）
- 发电量：kWh（AC 侧）
- 装机容量：kWp

### 4.4 PV 发电量模块（已确认口径，用于二期）
- 方位角：**0°=正南，东为负，西为正**
- 倾角：**PVGIS optimal（自动最优倾角）**
- 年型：**典型年（TMY）**
- 发电量口径：**AC 侧**

---

## 5. 功能需求（Functional Requirements）

### 5.1 输入与位置解析

**5.1.1 输入模式**
- 模式 A：经纬度（lat, lon）
- 模式 B：地址字符串（允许用户输入“公司名称 + 城市/园区/街道”等）

**5.1.2 解析规则**
- 若提供经纬度：直接使用
- 若提供地址：后端调用地理编码服务获得候选点；默认取第 1 条，同时返回候选列表（可选）

**5.1.3 错误提示**
- 无结果：提示“未解析到位置，请补充城市/区县或改用经纬度”
- 多结果：提示“存在多个候选位置，请选择/补充信息”

### 5.2 数据源选择与能力矩阵

**数据源**
- PVGIS：免费、无需 key（有调用频率限制），支持 TMY/逐时等
- CAMS：通过 SoDa（通常以 email 作为标识），覆盖全球、变量更标准化

**一期默认策略**
- 默认 PVGIS
- 需要更灵活时间范围或做对比时启用 CAMS

### 5.3 辐照数据查询（一期核心）

**5.3.1 PVGIS｜逐时序列（Series）**
- 输入：`lat/lon`、`startYear/endYear`、是否返回分量（components）
- 输出：逐时记录（含时间字段与辐照相关字段）
- 备注：若 PVGIS 仅支持按年粒度获取，则前端/后端可在返回后做时间范围筛选

**5.3.2 PVGIS｜典型年（TMY）**
- 输入：`lat/lon`、输出格式
- 输出：8760 条典型年逐时数据 + 元数据

**5.3.3 CAMS｜逐时序列**
- 输入：`lat/lon`、`start/end`、`time_step`（默认 1h）、`identifier`（如 all-sky/clear-sky）
- 输出：逐时记录（ghi/dni/dhi 等标准字段）

**5.3.4 字段规范化（统一数据模型）**
- 统一输出结构：`metadata` + `data[]`
- `data[]` 建议至少包含：
  - `time`（ISO8601）
  - `ghi`、`dni`、`dhi`（若源端没有则置空）
  - `source_raw`（可选：保留原字段字典，便于追溯）

### 5.4 结果展示（一期）
- 指标区（元信息）
  - 位置（解析结果）、数据源、时间范围、时间基准、单位
- 图表区（至少一个）
  - 日内曲线（选定日期/典型日）或全年概览曲线
- 表格区
  - 支持搜索/筛选（按月份/日期）
  - 大数据量（TMY 8760 行）要求不卡顿（虚拟滚动或分页）

### 5.5 导出与分享（一期）
- 导出 CSV：
  - 第一部分：metadata（或单独 JSON 文件，二选一）
  - 第二部分：逐时数据明细
- （可选）导出 PNG（图表截图）或简单报告（HTML/PDF）

### 5.6 PV 发电量评估（二期）

**5.6.1 系统参数**
- `peakPower`（kWp，默认 10，可编辑）
- `azimuth`（°，默认 0，可编辑，口径见 4.4）
- `loss`（%，默认 14，可编辑）
- `tilt`：不传/或显式使用 PVGIS optimal

**5.6.2 结果**
- 年发电量（kWh，AC）
- 月发电量（12 个月）
- 逐时发电量（TMY 8760h：功率/电量 + POA 等）

**5.6.3 衍生指标**
- 首年满发小时：`annualEnergy(kWh) / peakPower(kWp)`
- PR（按 PVGIS 可提供的 POA 口径累计计算）

---

## 6. 后端接口（建议稿）

> 约定：前端不直连第三方；后端统一代理、校验、缓存、口径转换。

### 6.1 `POST /api/geocode`
**请求**
```json
{ "query": "某某公司 杭州 余杭区 xx路", "limit": 5 }
```
**响应**
```json
{
  "candidates": [
    { "lat": 30.27, "lon": 120.15, "displayName": "…", "provider": "nominatim", "confidence": 0.7 }
  ]
}
```

### 6.2 `POST /api/irradiance/series`
**请求**
```json
{
  "lat": 30.27,
  "lon": 120.15,
  "source": "pvgis",
  "start": "2023-01-01",
  "end": "2023-12-31",
  "options": { "components": true }
}
```
**响应（统一结构）**
```json
{
  "metadata": {
    "source": "pvgis",
    "lat": 30.27,
    "lon": 120.15,
    "timeRef": "UTC",
    "unit": { "irradiance": "W/m2" }
  },
  "data": [
    { "time": "2023-01-01T10:00:00Z", "ghi": 650, "dni": 500, "dhi": 150, "sourceRaw": {} }
  ]
}
```

### 6.3 `POST /api/irradiance/tmy`
**请求**
```json
{ "lat": 30.27, "lon": 120.15, "source": "pvgis" }
```
**响应**
- 同 `metadata + data[]`，且 `data.length == 8760`

### 6.4 `POST /api/pv/summary`（二期沿用现有 PRD）
**请求**
```json
{ "lat": 30.27, "lon": 120.15, "peakPower": 10, "azimuth": 0, "loss": 14 }
```
**响应**
```json
{ "annualEnergy": 12500, "monthlyEnergy": [900, 850], "fullLoadHours": 1250, "pr": 0.78 }
```

### 6.5 `POST /api/pv/hourly`（二期）
**响应**
```json
[
  { "time": "2023-01-01T10:00:00Z", "pvPower": 3.2, "poaIrradiance": 650 }
]
```

---

## 7. 非功能需求（NFR）

### 7.1 性能
- 单次查询（典型年 8760）后端响应 ≤ 5s（含第三方耗时的情况下尽量做到）
- 前端渲染 8760 行不明显卡顿（虚拟滚动/分页）

### 7.2 缓存与限流
- 缓存 Key：`hash(source, lat, lon, params, timeRange, version)`
- 同参命中缓存不再请求第三方
- 对第三方调用做限流与退避重试（避免触发封禁）

### 7.3 稳定性
- 超时、重试、熔断（第三方不可用时给出降级提示）
- 统一错误码与可读错误信息

### 7.4 合规与说明
- 页面/导出中明确标注数据来源（PVGIS / CAMS）与适用场景：投前评估、非发电保证

---

## 8. 验收标准（一期 MVP）

- 输入经纬度/地址任一方式可用，错误可解释、可纠正
- PVGIS 逐时序列或 TMY 查询成功，能展示图表 + 表格
- 导出的 CSV 可被 Excel/数据分析工具直接使用，且包含元数据（数据源、单位、时间基准）
- 同一参数多次查询命中缓存（可通过日志或返回字段验证）

---

## 9. 开发计划（里程碑 + 可勾选任务）

> 建议以 7–10 个工作日完成一期 MVP；二期按需插入。

### 阶段 0｜准备与口径固化（Day 0）
- ☐ 确认一期交付形态（Web/桌面/CLI）：建议 Web（前端 + 后端代理）
- ☐ 固化时间/单位/字段规范化口径（见第 4、5.3.4）

### 阶段 1｜位置输入与地理编码（Day 1）
- ☐ 前端：经纬度/地址输入（Tab 切换）
- ☐ 后端：`/api/geocode`（至少接 1 个 provider），返回候选与精度信息

### 阶段 2｜数据源适配（Day 2–3）
- ☐ PVGIS：实现 `irradiance/series`、`irradiance/tmy` 调用与解析
- ☐ CAMS：实现逐时序列调用（含 email 配置）与字段映射
- ☐ 统一输出 schema（metadata + data[]），补齐 `timeRef/unit`

### 阶段 3｜展示与导出（Day 4–5）
- ☐ 前端：图表 + 表格（支持 8760 行）
- ☐ 前端：导出 CSV（前端导出或后端生成）
- ☐ 基础对比（同地点 PVGIS vs CAMS，可选）

### 阶段 4｜性能与稳定性（Day 6）
- ☐ 缓存（同参命中）
- ☐ 重试/超时/错误码
- ☐ 基础日志（请求耗时、第三方错误）

### 阶段 5｜交付与文档（Day 7）
- ☐ 抽检 2–3 个城市数据合理性（曲线形态、量级）
- ☐ 使用说明：输入、字段解释、数据源差异、限制

### 二期｜PV 发电量评估模块（Day 8+，按需）
- ☐ 复用位置输入与缓存机制
- ☐ 接入 PVGIS PV 计算：年/月/逐时（TMY）
- ☐ 计算 PR、满发小时，完成方案对比与 PDF 报告（可选）

---

## 10. 风险与限制（提前说明）

- 地理编码：免费服务（如 Nominatim）对“公司名称”解析不稳定，建议强制用户补充城市/区县或提供可替换的国内地图服务提供商
- PVGIS/CAMS 的字段与时间口径存在差异，必须通过“统一 schema + metadata”解决可解释性
- 第三方接口存在频控与不稳定性，需要缓存/限流/重试与降级提示

