# 可验证性与追溯方案（已实现）

**更新时间**：2025-12-29  
**目标**：把“地址 → 坐标 → PVGIS 数据”的链路从黑盒变为可验证、可复现、可追溯。

---

## 1. 位置可验证（避免“同名不同地”）

### 1.1 候选位置明确选择
- 地址解析返回多个候选时，前端以「候选列表（单选）」展示，每条候选包含：
  - 标准化地址（display_name）
  - 坐标（lat/lon）
- 用户切换候选后会清空“确认”状态，避免误用旧确认。

### 1.2 强制确认坐标后才能查询
- 在地址模式下：若存在候选位置，必须勾选「我已确认该坐标用于查询」后才能发起 PVGIS 查询。
- 若用户直接点“查询辐照数据”而未先解析地址：
  - 系统会先自动解析并展示候选
  - 提示用户确认坐标后再查询

### 1.3 地理编码默认中国优先
- 地址解析默认限定 `countryCodes=cn`，减少全球同名干扰。
- 可手动切换“解析范围：全球”以放开限制。

---

## 2. 请求可复现（可复制 URL 与 inputs）

前端“概览”卡片新增「调试信息」面板，包含：

### 2.1 Geocode 请求
- `query`
- `countryCodes`
- `requestUrl`（可一键复制）

### 2.2 PVGIS 请求与输入
- PVGIS `requestUrl`（可一键复制）
- PVGIS `inputs` 原始对象（`rawInputs`，可一键复制 / 可滚动查看）
- 最佳倾角计算（optimalangles）的 `requestUrl`（可一键复制）

> 这些信息用于：任何结果都能在浏览器/命令行直接复现、核对。

---

## 3. 地图确认（直观校验坐标）

在地址模式且已解析出候选坐标时，页面新增「地图确认（OpenStreetMap）」模块：
- 内嵌 OSM 地图 + marker
- 提供“在新窗口打开地图”链接

用于快速判断：解析到的点位是否就是目标地址（例如“杭州西湖” vs 其他城市同名地点）。

---

## 4. 时间口径一致（CN/UTC 可切换）

### 4.1 页面显示
- 数据源时间基准：PVGIS 为 UTC
- 前端提供显示切换：`中国时间(CN, Asia/Shanghai)` / `UTC`
- 曲线与表格可绑定同一“曲线日期”，避免“同一天对不上”

### 4.2 CSV 导出
- 导出同时包含：
  - `time_cn`：中国时区时间（带 `+08:00`）
  - `time_utc`：UTC 原始时间（带 `Z`）
- `metadata` 里标注导出时区信息（`exportTimeRef=Asia/Shanghai`）

---

## 5. 相关代码位置（快速定位）

- 地理编码 API：`src/app/api/geocode/route.ts`
- PVGIS API：`src/app/api/irradiance/tmy/route.ts`、`src/app/api/irradiance/series/route.ts`、`src/app/api/irradiance/optimal/route.ts`
- PVGIS 请求拼装与解析：`src/lib/pvgis.ts`
- 前端主页面与调试面板：`src/app/ui/App.tsx`

